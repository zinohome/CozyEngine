你是 CozyEngine 项目的 AI 编程助手（Cursor）。你必须严格遵守以下规则；若发现与现有代码/文档冲突，优先以“更新设计文档并同步代码”为准则解决冲突。

========================
0) 语言与沟通
========================
- 默认使用中文（简体）输出。
- 先对齐目标与约束，再动手改代码；重要决策必须在 docs 里落地（见 ADR 规则）。

========================
1) 最高优先级：设计文档约束（MUST）
========================
- 开发必须以 `docs/engine-v2/` 的设计文档为准（编排/上下文/插件/接口/降级/可观测等）。
- 任何实现如果偏离设计，必须先更新“原设计文档”并升级版本，再修改代码；禁止仅在代码里默默变更设计。
- 设计变更不得随意新建设计文档：应在原文件内修改并升级版本号（见 2）。
- 所有文档必须位于 `docs/` 目录下，并按用途放入子目录（例如：`docs/engine-v2/`、`docs/standards/`、`docs/adr/`、`docs/runbooks/` 等）。

========================
2) 文档规范（MUST）
========================
- 文件名必须包含版本与日期：`...-vX.Y-YYYY-MM-DD.md`
  - 版本升级时：重命名文件以体现新版本（例如 v2.0 -> v2.1），并在文档顶部更新“更新日期/版本”。
- 每个文档顶部必须包含：
  - `> **文档版本**: vX.Y`
  - `> **更新日期**: YYYY-MM-DD`
- 设计类文档更新规则：
  - 小改动：提升 patch（v2.0 -> v2.0.1，可选）
  - 行为/接口/边界变化：至少提升 minor（v2.0 -> v2.1）
  - 架构级变化：提升 major（v2.x -> v3.0）
- 禁止“重复文档/分叉文档”：同一主题只维护一个主文档；历史通过“版本升级 + 变更记录”体现。

========================
3) ADR（架构决策记录）规则（SHOULD）
========================
- 任何影响边界/接口/数据/安全/可用性的关键决策，必须新增 ADR：
  - 路径：`docs/adr/ADR-####-标题-v1.0-YYYY-MM-DD.md`
  - 只记录“决策与理由”，不要复制大段设计文档内容。

========================
4) Python/FastAPI 最佳实践（MUST）
========================
- 严格类型注解；公共接口必须有类型与清晰 docstring。
- 异步优先：I/O（HTTP/DB/Redis）使用 async；避免在 event loop 中跑阻塞代码。
- 依赖注入：使用 FastAPI Depends；API 层保持轻薄，不写业务规则。
- 统一错误模型：所有异常必须映射到统一错误码结构（见 `docs/engine-v2/11-错误处理与可观测性-*.md`）。
- 结构化日志：必须包含 request_id/user_id/session_id/personality_id（若可得），禁止日志泄露密钥与 PII。

========================
5) AI 应用工程实践（MUST）
========================
- 上下文构建必须支持：并行（Knowledge/UserProfile/ChatMemory）、超时、降级、token 预算。
- 工具调用必须：白名单 + 权限校验 + 审计；禁止任意工具执行。
- SSE 流式必须遵循 OpenAI 兼容格式，结束必须发送 `[DONE]`。

========================
6) 测试与质量门槛（SHOULD）
========================
- 关键链路必须有单测/集测：上下文并行、超时降级、工具循环、权限边界、SSE 协议。
- 修改核心逻辑必须同步更新测试与文档版本。

========================
7) 仓库卫生（MUST）
========================
- 不把密钥写入代码/文档/日志；示例使用 `.env.example` 或占位符。
- 不引入无关大文件；不提交生成物/缓存（除非明确要求）。

