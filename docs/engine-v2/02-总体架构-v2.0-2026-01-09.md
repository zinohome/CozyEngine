## 02. 总体架构（CozyEngine v2）

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 2.1 总体分层

- **API 层**：HTTP/WS/SSE 协议适配与鉴权；保持薄逻辑。
- **编排层（Orchestrator）**：把一次对话请求拆解为阶段：准备 → 上下文 → 工具 → 模型生成 → 结果落库/回写。
- **上下文层（Context）**：把人格/会话/用户画像/知识/记忆组装成 prompt/messages，并做 token 预算。
- **引擎层（Engines，插件化）**
  - AI Engine：OpenAI/Ollama/本地推理等
  - Tools Engine：MCP/内置工具
  - Knowledge Engine：知识检索/写入（如 Cognee）
  - UserProfile Engine：画像获取/更新（如 Memobase）
  - ChatMemory Engine：会话记忆检索/写入（如 Mem0）
  - Voice Engine：STT/TTS/Realtime（可选）
- **数据层（Storage）**：Postgres（会话/消息/用户/审计）、Redis（缓存/队列）、VectorDB（可选）。

### 2.2 核心运行时链路（非流式/流式）

#### 非流式（HTTP）

1. API 解析 `ChatCompletionRequest`
2. Orchestrator：鉴权/会话校验/人格加载/模型选择
3. Context：并行获取（知识/画像/记忆）+ 历史消息摘要（可选）
4. Tools：按人格与请求选择工具，生成 OpenAI tools schema
5. AI Engine：一次生成（工具调用可循环）
6. Persistence：保存消息、回写画像/记忆（异步优先）
7. 返回 OpenAI 兼容响应

#### 流式（SSE）

1-4 同上
5. AI Engine：SSE 流输出；遇到 tool_calls 时进入工具调用循环（有限迭代）
6. 过程中增量保存（可选）/最终落库（必选）
7. SSE 结束帧（finish_reason）

### 2.3 “三大人格化引擎”的定位（v2 一等公民）

- **Knowledge（长期稳定）**：人格知识库、专业资料、产品文档等；查询多、写入少。
- **UserProfile（中长期）**：偏好、习惯、禁忌、口吻；更新频率中等。
- **ChatMemory（短期/会话）**：最近对话要点、短期事实；更新频率高、可异步写入。

### 2.4 并行与降级策略（硬性要求）

- **并行**：Knowledge/UserProfile/ChatMemory 必须并行调用，整体延迟 ≈ max(Tk, Tp, Tm)。
- **超时**：每个引擎单独超时（例如 0.3~0.8s 可配置）。
- **降级**：单个引擎失败返回空结果，不影响主回答；降级必须写入观测字段。
- **可审计**：本次请求启用了哪些引擎、命中哪些缓存、降级原因是什么，必须可追踪。

### 2.5 关键设计决策（ADR 摘要）

- **ADR-001**：编排器模式作为唯一主入口，API 层不承载业务规则。
- **ADR-002**：三大人格化引擎接口稳定化，并通过插件系统加载。
- **ADR-003**：配置以 YAML 为主，环境变量为密钥/环境差异兜底。
- **ADR-004**：默认 SSE 流式输出支持工具调用循环（有限迭代）。

