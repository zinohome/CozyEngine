## 04. 目录结构与分层规范

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 4.1 推荐仓库结构（CozyEngine 内的后端引擎子项目）

> 目标是“后端引擎可以独立运行/独立部署”，同时允许 CozyEngine 未来扩展更多能力。

```
CozyEngine/
  backend/
    app/
      api/                 # API 层（OpenAI兼容/CozyChat兼容）
      core/                # 领域核心：人格、会话、权限、策略
      orchestration/       # 编排层（Orchestrator）
      context/             # 上下文层（组装、token预算、意图分析）
      engines/             # 引擎层（插件化）
      storage/             # 数据访问层（DB/Redis/向量库适配）
      middleware/          # 中间件（限流、性能、追踪）
      observability/       # 日志/指标/追踪/Sentry
      utils/               # 工具库（少且稳定）
    config/                # YAML 配置（按域拆分）
    tests/                 # 单元/集成/端到端
    scripts/               # 运维脚本
    README.md
  docs/
    engine-v2/             # 本套设计文档（你正在阅读）
```

### 4.2 分层依赖规则（必须）

- **API 层**只能依赖 orchestration/context/core 的接口，不得直接依赖具体引擎实现。
- **编排层**依赖 context + engines（抽象接口）+ storage（抽象接口），不得依赖 FastAPI Request/Response（通过 DTO 传递）。
- **context 层**只能依赖 engines（抽象）与少量 core 结构；不得直接依赖数据库 ORM（通过 storage 适配器）。
- **engines 层**不得反向依赖 orchestration/context/api。
- **storage 层**不得依赖 engines（避免循环）；如需要向量检索，可通过“向量存储适配器”抽象。

### 4.3 单例与生命周期规范（继承 CozyChat 的优点并制度化）

CozyChat 的实现表明：人格注册表、引擎池、工具工厂等适合“应用生命周期单例”。但 v2 必须明确：

- **单例仅限无业务态组件**：缓存、连接池、客户端、注册表。
- **业务态必须显式传入**：user_id/session_id/request_id 不得存入单例。
- **必须支持测试替换**：单例的创建必须通过工厂/容器注入（允许测试注入 Mock）。

### 4.4 文件大小与职责约束（避免“大文件复活”）

- 单文件建议 < 400 行；超过需拆分（除非纯模型/常量）。
- 编排器只负责“阶段调度”，不得包含复杂 SQL、复杂 prompt 拼接、复杂工具实现。
- 任何“兼容层”代码必须隔离在 `api/compat/*`，禁止污染主链路。

