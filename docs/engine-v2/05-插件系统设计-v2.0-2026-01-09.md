## 05. 插件系统设计

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 5.1 目标

- **可插拔**：不改核心代码即可替换/新增引擎实现。
- **可发现**：启动时可列出可用插件与能力。
- **可约束**：插件必须声明接口版本、能力边界与权限需求。
- **可观测**：插件加载、健康检查、调用失败均可追踪。

### 5.2 插件类型

- **内置插件（builtin）**：随 CozyEngine 发布，默认启用。
- **外置插件（package）**：以 Python 包形式安装；通过 entry-points 或配置加载。
- **远程插件（remote service）**：引擎实现为远程服务客户端（如 Cognee/Mem0/Memobase）。

### 5.3 插件清单与选择机制

#### 配置驱动（主）

在 `backend/config/engines.yaml` 声明每类引擎的 provider 与参数：

- `ai.provider = openai`
- `knowledge.provider = cognee`
- `userprofile.provider = memobase`
- `chatmemory.provider = mem0`
- `tools.provider = mcp`

#### 运行时选择（辅）

允许请求级覆盖（受控）：

- **允许**：在人格配置或请求字段中指定 `model`、`ai_provider`（白名单）。
- **禁止**：请求直接指定任意插件名（防止越权调用）。

### 5.4 注册与工厂模式（参考 CozyChat 的优势但统一规范）

CozyChat 已存在类似的：

- 引擎池：按 (provider, model) 缓存
- 工具工厂：按 allowed_tools 缓存
- 人格注册表：启动加载缓存

v2 统一为：

- **Registry（注册表）**：记录 provider → engine_class
- **Factory（工厂）**：从配置创建 engine 实例
- **Pool（池/缓存）**：对“无业务态”的 engine/client 进行缓存复用

### 5.5 插件版本与兼容

- 每个引擎接口都有 `api_version`（例如 `"v1"`）。
- 插件必须声明支持的 `api_version`，不匹配则拒绝加载。
- 重大变更通过新增接口版本完成，不破坏旧版本。

### 5.6 安全与权限（插件必须声明）

插件需要声明：

- **网络访问**：是否需要访问外网/内网服务
- **数据访问**：是否读取用户消息/画像/知识库
- **工具权限**：是否允许执行有副作用的动作（写文件/发 HTTP/调用内部系统）

编排器必须基于“人格配置 + 用户角色 + 服务策略”做最终授权。

