## 06. 引擎接口规范

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 6.1 统一约定（所有引擎 MUST）

- **initialize()**：初始化连接/客户端；允许幂等。
- **health_check()**：快速健康检查；不得执行重操作。
- **close()**：释放资源；允许幂等。
- **timeout**：引擎方法必须支持上层超时控制（协程可被取消）。
- **返回空结果协议**：失败时不得抛出到主链路（由上层 `_safe_call` 兜底），引擎侧应返回可识别的空结构或抛出可分类异常。

### 6.2 AI Engine（聊天生成）

#### 能力

- `chat()`：非流式生成
- `chat_stream()`：流式生成（SSE chunk）
- `supports_tools`：是否支持 tools/tool_calls
- `supports_vision`：是否支持图像（可选）

#### 输入（概念）

- messages：OpenAI 风格消息序列（role/content/tool_calls 等）
- tools：OpenAI tools schema（可选）
- generation params：temperature/max_tokens/top_p 等

#### 输出（概念）

- content + finish_reason + usage
- 或 stream chunks（delta/content/tool_calls）

### 6.3 Tools Engine（工具调用）

#### 能力

- 列出工具：`list_tools()`
- 将工具导出为 OpenAI tools schema：`to_openai_tools(tool_names)`
- 执行工具：`invoke(name, args, context)`

#### 约束

- 工具必须声明副作用等级：read-only / write / network / dangerous
- 编排器根据人格与权限做最终授权

### 6.4 Knowledge Engine（知识检索/写入）

- `search_knowledge(query, dataset_names, top_k) -> list[result]`
- `add_knowledge(content, dataset_name, metadata) -> knowledge_id`

结果建议包含：`content`, `score`, `source`, `dataset_name`, `metadata`

### 6.5 UserProfile Engine（画像读取/更新）

- `get_profile(user_id, max_token_size) -> {profile_text, token_size, ...}`
- `update_profile(user_id, messages) -> bool`

### 6.6 ChatMemory Engine（会话记忆）

- `search_memories(query, user_id, session_id, top_k) -> list[memory]`
- `add_memory(user_id, session_id, messages) -> memory_id | list[memory_id]`

### 6.7 Voice Engine（可选）

- STT：`transcribe(audio) -> text`
- TTS：`speak(text, voice) -> audio`
- Realtime：按 provider 定义会话协议

### 6.8 错误类型建议（引擎层）

- `EngineInitError`
- `EngineTimeoutError`
- `EngineAuthError`
- `EngineRateLimitError`
- `EngineInvalidRequestError`
- `EngineUnavailableError`

上层必须把这些错误转换成统一的 `CozyError`（带 error_code）。

