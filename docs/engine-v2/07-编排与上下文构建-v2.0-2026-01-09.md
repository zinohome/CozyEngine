## 07. 编排与上下文构建

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 7.1 编排器职责（对标 CozyChat 的 `ChatOrchestrator` 但更纯粹）

编排器 MUST 只做“阶段调度”，不做具体实现细节：

- **准备阶段**：鉴权、会话校验、人格选择、模型选择、生成参数规范化。
- **上下文阶段**：调用 ContextService 构建 ContextBundle，并转换为 AI Engine messages。
- **工具阶段**：根据人格/请求，选择允许工具并生成 tools schema。
- **生成阶段**：调用 AI Engine（流式/非流式），并处理工具调用循环。
- **落库/回写阶段**：保存消息、异步写入 ChatMemory、更新 UserProfile（可选）。
- **错误与降级**：对引擎失败做降级，对不可恢复错误返回统一错误。

### 7.2 ContextService（主路径）

#### 输入

- user_id（内部统一 UUID）
- session_id
- current_message
- personality_config（人格配置）
- max_tokens（上下文预算）

#### 输出（ContextBundle）

- system_prompts：人格提示词 + 用户画像摘要 + 其他系统约束
- recent_messages：最近 N 条消息（可配置）
- summarized_history：历史摘要（可选）
- retrieved_knowledge：知识检索结果（可选）
- retrieved_memories：记忆检索结果（可选）
- user_profile：画像结果（可选）
- token_budget：token 使用与预算明细
- metadata：本次启用的引擎、缓存命中、降级原因、耗时等

### 7.3 三大人格化引擎并行调用（必须）

- 并行：Knowledge/UserProfile/ChatMemory 三者并行调用。
- 意图驱动：通过 IntentAnalyzer 决定启用哪些引擎、top_k、max_tokens 等。
- 超时：每个引擎单独超时；超时返回空。
- 结果归一：所有结果必须转换为统一结构，避免下游对 provider 产生耦合。

### 7.4 Token 预算（必须）

为避免“上下文越界导致模型失败”，ContextService 必须实现：

- 系统提示词预算（人格 prompt + 画像）
- 历史消息预算（最近消息 N + 重要消息）
- 检索结果预算（知识/记忆）
- 预留生成预算（completion max_tokens）

策略建议：

- 先保留人格系统 prompt（最高优先级）
- 再保留最近消息（中优先级）
- 再加入画像/记忆/知识（可裁剪）
- 最后加入摘要（可替代历史）

### 7.5 工具调用循环（流式/非流式统一语义）

CozyChat 已实现“有限迭代”的工具调用循环，v2 规定：

- **最大迭代次数可配置**（默认 10）
- **每次工具调用必须记录审计事件**（工具名、参数、耗时、成功/失败）
- **工具输出必须以 tool role 消息回填到 messages**
- **工具调用失败处理**
  - 允许：单次失败 → 工具错误消息回填，继续让模型生成解释/降级方案
  - 禁止：无限重试

### 7.6 兼容层处理（必须隔离）

如果需要兼容旧行为（例如旧 memory manager / 旧 context builder）：

- 只能放在 `api/compat/*` 或 `orchestration/compat/*`
- 主链路不得引用 legacy 实现
- 兼容层必须有移除日期与迁移开关

