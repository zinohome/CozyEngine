## 09. 数据与存储设计

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 9.1 数据分层

- **事务数据（Postgres）**：用户、会话、消息、权限、审计事件。
- **缓存与队列（Redis）**：热点缓存、限流状态、异步写入队列（可选）。
- **向量/检索存储（可选）**：如果 Knowledge/Memory 引擎自带存储，则只保存引用；否则提供向量存储适配器。

### 9.2 核心表（概念模型）

#### users

- id（uuid）
- username/email/password_hash/role/status
- created_at/updated_at

#### sessions

- id（uuid）
- user_id（uuid）
- personality_id（string）
- title/message_count/last_message_at
- deleted_at（软删）

#### messages

- id（uuid）
- session_id（uuid）
- user_id（uuid）
- role（enum）
- content（text）
- message_metadata（jsonb）
- created_at

#### audit_events（推荐新增）

- id（uuid）
- request_id（string）
- user_id/session_id/personality_id
- event_type（string：TOOL_CALL / ENGINE_DEGRADED / AUTH_FAIL / …）
- payload（jsonb）
- created_at

### 9.3 引擎数据与引用策略

三大人格化引擎的结果建议采用“引用 + 轻量摘要”的方式进入消息链路：

- Knowledge：保存 `source_id/source_url` + `content_snippet`
- UserProfile：保存 `profile_text`（截断）+ `version/hash`
- ChatMemory：保存 `memory_id` + `content_snippet` + `timestamp`

### 9.4 异步写入策略（继承 CozyChat 的 Worker 思路但抽象化）

- ChatMemory / UserProfile 更新可异步
  - **必须可配置**：sync/async
  - **必须可回压**：队列长度、批量大小、失败重试策略
  - **必须可观测**：成功率、积压量、耗时

### 9.5 软删与合规

- 会话/消息建议默认软删（deleted_at），便于审计与误删恢复。
- 对于合规删除（GDPR 类），提供“硬删任务”后台执行并可审计。

