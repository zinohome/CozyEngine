## 10. 配置与环境变量

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 10.1 配置优先级（继承 CozyChat 的成熟做法）

**YAML > 环境变量（Settings）> 代码默认值**

目的：

- YAML 负责“结构化配置与默认策略”
- 环境变量负责“密钥/环境差异/部署差异”
- 代码默认值只做兜底

### 10.2 配置拆分（命名空间）

建议拆分为：

- `app.yaml`：应用名、环境、CORS、基础开关
- `api.yaml`：路由前缀、OpenAI 兼容开关、SSE 参数
- `engines.yaml`：各引擎 provider 与参数
- `context.yaml`：上下文策略、token 预算、并行与超时
- `tools.yaml`：工具白名单、MCP 服务发现配置
- `storage.yaml`：DB/Redis 配置（非密钥部分）
- `observability.yaml`：日志/指标/追踪
- `security.yaml`：鉴权策略、RBAC、审计开关

### 10.3 环境变量（示例字段）

- **基础**
  - `APP_ENV`
  - `APP_SECRET_KEY`
  - `JWT_SECRET_KEY`
- **数据库/缓存**
  - `DATABASE_URL`
  - `REDIS_URL`
- **AI**
  - `OPENAI_API_KEY`
  - `OPENAI_BASE_URL`
  - `OLLAMA_BASE_URL`
- **人格化引擎**
  - `COGNEE_API_URL` / `COGNEE_API_TOKEN`
  - `MEMOBASE_PROJECT_URL` / `MEMOBASE_API_KEY`
  - `MEM0_API_URL` / `MEM0_API_KEY`
- **可观测**
  - `SENTRY_DSN`
  - `SENTRY_ENABLE`

### 10.4 配置校验与版本化（必须）

- 所有 YAML 必须有 schema（Pydantic Model 或 JSON schema）。
- 启动时必须校验：
  - 引擎 provider 是否存在
  - 必需密钥是否缺失
  - timeout/阈值是否合理（边界值）
- 配置必须可追踪版本：
  - `config_version`
  - 关键配置变更写入日志（不包含密钥）

