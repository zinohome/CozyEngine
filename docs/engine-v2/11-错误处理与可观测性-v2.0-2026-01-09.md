## 11. 错误处理与可观测性

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 11.1 错误分层（统一 CozyError）

统一错误对象建议包含：

- `code`：稳定错误码
- `message`：简短描述
- `http_status`：HTTP 状态码（API 层使用）
- `request_id`：追踪 ID
- `details`：调试信息（可选，生产可关闭）

错误码建议按域划分：

- `AUTH_*`：认证/鉴权
- `VALIDATION_*`：参数校验
- `RESOURCE_*`：资源不存在/无权限
- `ENGINE_*`：引擎调用失败/超时/限流
- `STORAGE_*`：数据库/缓存
- `TOOL_*`：工具调用失败/越权

### 11.2 观测三件套

#### 日志（必选）

- 结构化 JSON 日志
- 必须字段：`timestamp`, `level`, `request_id`, `user_id?`, `session_id?`, `personality_id?`, `latency_ms`, `route`, `status`
- 引擎调用记录：provider、耗时、是否降级、错误码（不记录密钥）

#### 指标（建议）

- QPS / 延迟（P50/P95/P99）
- 引擎调用成功率/超时率/降级率
- SSE 连接数、平均持续时间
- 工具调用次数/失败率
- 队列积压量（异步写入）

#### 追踪（可选）

- request span
- context build span（并行子 span：knowledge/profile/memory）
- model generation span
- tool invocation span
- persistence span

### 11.3 降级与告警（必须可观测）

任何降级必须：

- 写入 `metadata.degraded = true`
- 写入 `metadata.degrade_reasons[]`
- 记录日志（warn）+ 指标计数

### 11.4 隐私与脱敏

- 日志默认不记录原文消息；如需记录，必须有开关 + 脱敏策略。
- Sentry/追踪不得上传 PII（默认关闭 send_default_pii）。

