## 12. 性能与缓存策略

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 12.1 性能目标（可量化）

- **P50 延迟**：交互式可用（目标值按部署环境确定）
- **P95 延迟**：受控（引擎超时 + 降级保证）
- **降级率**：低于阈值（否则告警）

### 12.2 并行策略（核心）

- 上下文构建阶段：
  - Knowledge/UserProfile/ChatMemory 并行
  - DB 读取最近消息/摘要并行（若互不依赖）

### 12.3 缓存分层（建议）

参考 CozyChat 的 MultiLevelCache 思路，v2 建议：

- **L1（进程内）**：TTLCache（毫秒级），适合小对象：人格配置、工具 schema、短期 profile 文本。
- **L2（Redis）**：跨进程共享，适合热点：知识检索结果摘要、用户画像摘要、会话摘要。

缓存 key 必须包含：

- user_id/session_id/personality_id（按需）
- query hash（知识/记忆）
- config_version（避免配置变更导致脏读）

### 12.4 超时与预算（必须）

- 引擎调用必须有超时预算：
  - Knowledge：0.5s（示例）
  - UserProfile：0.3s
  - ChatMemory：0.4s
- 超时后返回空结果并降级，不阻塞主链路。

### 12.5 SSE 流式优化

- `X-Accel-Buffering: no`（反代不缓冲）
- chunk 发送节奏：避免过小 chunk 造成过多 flush
- 断线重连策略：客户端负责，服务端保持幂等（request_id）

