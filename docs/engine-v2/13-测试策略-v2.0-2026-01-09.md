## 13. 测试策略

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 13.1 测试金字塔

- **单元测试（60%）**
  - 引擎接口的适配层（mock 外部服务）
  - ContextService：token 预算、并行、降级、空结果协议
  - Orchestrator：阶段调度、工具循环边界
- **集成测试（30%）**
  - API → Orchestrator → Context → Engines（使用本地 stub server 或 docker）
  - DB/Redis 的读写一致性、事务与软删
- **端到端（10%）**
  - 关键用户路径：登录 → 建会话 → 连续对话 → 工具调用 → SSE 流式

### 13.2 必测场景清单（最小集合）

- **上下文并行**：三引擎并行时总耗时≈max；单引擎超时不影响整体返回。
- **降级可观测**：降级时 metadata 与日志/指标均能反映。
- **工具调用循环**：工具成功/失败/多轮调用/达到最大迭代次数。
- **SSE 协议兼容**：chunk 格式与 `[DONE]` 结尾；断线不导致服务端资源泄漏。
- **权限**：用户只能访问自己的 session/messages；管理员能力受控。

### 13.3 Mock 与契约测试

- 对外部引擎（Cognee/Mem0/Memobase/OpenAI）建议做：
  - **契约测试**：固定输入 → 断言输出结构（不要求稳定内容）
  - **超时/异常注入**：模拟网络超时、401、429、500

