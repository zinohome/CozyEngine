## 14. 迁移与实施计划（从 CozyChat 后端到 CozyEngine 引擎化）

> **文档版本**: v2.0  
> **更新日期**: 2026-01-09  


### 14.1 总体策略

- **先“并行接管”，再“切流量”**：先在 CozyEngine 中跑通同等能力，再逐步把 CozyChat 前端/客户端切到新服务。
- **保持兼容**：OpenAI 兼容 API 与 CozyChat 兼容 API 同时提供（过渡期）。
- **主链路先行**：Orchestrator + ContextService（新）+ 三大人格化引擎必须优先稳定。
- **旧系统受控退场**：旧 Memory API / legacy context 只作为兼容层存在，必须有移除计划。

### 14.2 阶段划分（建议）

#### Phase 0：准备（1-2 天）

- 梳理 CozyChat 现有后端依赖与启动流程（已完成分析）
- 在 CozyEngine 下建立 `backend/` 骨架与最小可运行 FastAPI
- 建立配置体系（YAML + env），打通日志/追踪基础

验收：

- `GET /health` 正常
- `GET /v1/personalities` 能读取人格（先复用配置目录）

#### Phase 1：核心聊天链路（3-5 天）

- 实现 v2 Orchestrator 主链路（非流式）
- 接入 AI Engine（先 OpenAI），跑通 `/v1/chat/completions`
- 消息落库（session/messages）

验收：

- 非流式回复正确
- 会话/消息能查询

#### Phase 2：流式 + 工具（3-5 天）

- SSE 流式输出
- 工具 schema 与工具调用循环
- MCP 工具发现（受控）

验收：

- 流式可用
- 工具可调用，最大迭代次数生效

#### Phase 3：人格化上下文（5-8 天）

- ContextService：并行调用三大人格化引擎（先接入远程实现）
- IntentAnalyzer：决定启用哪些引擎与参数
- token 预算与裁剪

验收：

- 三引擎并行、超时降级生效
- metadata 可观测（启用引擎、降级原因）

#### Phase 4：兼容层与切流量（3-7 天）

- CozyChat 兼容 API 补齐最小集合（sessions/messages/tools/audio）
- 对比测试：新旧返回差异分析
- 灰度切换：按用户/租户/环境切流量

验收：

- CozyChat 前端可无感运行（或最小改动）

#### Phase 5：退场与清理（持续）

- 标记 legacy API deprecated（仅兼容，不再扩展）
- 删除旧记忆 API/旧 context builder（在移除窗口后）

### 14.3 风险清单与对策

- **风险：新旧行为不一致导致前端问题**
  - 对策：增加对比测试与灰度；兼容层隔离；关键字段保持一致。
- **风险：外部引擎不稳定**
  - 对策：超时+降级；缓存；健康检查；熔断（可选）。
- **风险：配置复杂化**
  - 对策：命名空间 + schema 校验 + config_version；禁止无约束新增。

### 14.4 交付清单（Definition of Done）

- OpenAI 兼容 `/v1/chat/completions`（流式/非流式）
- sessions/messages/personality/tools 最小业务 API
- 三大人格化引擎并行与降级
- 关键链路指标与日志可用
- 单测/集测覆盖关键模块

