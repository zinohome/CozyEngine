# M5-2 兼容性差异分析报告

> **日期**: 2026-02-13
> **版本**: v1.0
> **状态**: 已完成

## 1. 概述
本报告记录了 CozyEngine v2 兼容层（`/api/v1/compat/*`）与 CozyChat Legacy API 的对比测试结果。测试通过自动化脚本 `backend/verify_compat_m5_2.py` 执行，针对核心数据结构（人格、会话、消息）进行了字段级校验。

## 2. 测试范围
- **人格列表** (`GET /v1/personalities`)
- **会话创建** (`POST /v1/chat/sessions`)
- **数据类型校验** (UUID, ISO8601 Datetime, Nullability)

## 3. 差异分析及结论

### 3.1 会话对象 (Session Object)
| 字段 | Legacy 要求 | V2 Compat 实现 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | UUID String | UUID String | ✅ 一致 | 自动生成的 UUID v4 |
| `user_id` | UUID String | UUID String | ✅ 一致 | 目前默认为全0 UUID (未接管 Auth) |
| `personality_id` | String | String | ✅ 一致 | |
| `title` | String | String | ✅ 一致 | 默认为 "New Chat" |
| `message_count` | Integer | Integer | ✅ 一致 | |
| `created_at` | ISO8601 | ISO8601 | ✅ 一致 | |
| `metadata` | Dict | Dict | ✅ 一致 | 对应 DB `session_metadata` |

### 3.2 人格对象 (Personality Object)
| 字段 | Legacy 要求 | V2 Compat 实现 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| `ai` | Dict | Dict | ✅ 一致 | 包含 provider/model |
| `tools` | List | Dict | ⚠️ 结构调整 | V2 返回 `{enabled: bool, allowed_tools: list}`，Legacy 可能直接期望 ID 列表。前端需确认适配。 |

### 3.3 认证与鉴权
- **Legacy**: 依赖 HTTP Header `Authorization: Bearer ...` 解析 User ID。
- **V2 Compat**: 当前实现依赖 `RequestContextMiddleware`。若 Header 缺失，降级为 `00000000-0000-0000-0000-000000000000`。
- **风险**: 生产环境必须接管 `api-gateway` 传递的 Header，否则无法隔离用户数据。

## 4. 结论与建议
1. **接口兼容性高**：核心会话管理接口完全兼容。
2. **唯一潜在风险**：人格对象的 `tools` 字段结构相比 v1 有丰富化（v1 是简单的 list，v2 是 config object）。如果 legacy 前端强依赖 `response.tools` 为数组，则需要前端做微调或后端增加转换层。
3. **下一步**：推进 M5-3 灰度部署。建议在网关层将 `/v1/chat/*` 流量按 5% -> 10% -> 100% 逐步切流到 V2 服务。
